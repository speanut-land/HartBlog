# 想想浏览器怎么做？

> 我一直在想，有什么办法可以将大学的计算机理论知识统统的串联起来？既然我是一个前端开发工程师，不如从最开始的浏览器输入开始一点点的将过去的知识串联起来。所以通过当我按下回车时，计算机的数据流到底是怎么样的呢？ 因此来写下这篇文章，站在数据的流动理清计算机的每一个点。

###按下"z"键

在此之前，当你输入第一个字符时，chrome会在地址的下方根据你的浏览记录、书签的收藏等内容给出合理的建议，你的每一次输入，chrome后台任务都会以更加精准提示展现给你。甚至在你输入第一个字符是"z"的时候，就会提示[zhihu.com](https://www.zhihu.com)。

### 按下"Enter"键

这里是数据出发的起始点。这个moment，通过键盘接口数字电路(通过二进制表示不同的键位，按下为1,没按为0)，将enter转换为**"13"键盘码值**。键盘控制器将键盘码转换成**ASCII**码通过IO总线专递给处理机（CPU），键盘会向CPU发起中断请求信号。数据通过USB线从键盘传输至计算机，计算机的USB控制器将传递的信号解码。之后将按键的码值传递给操作系统。（这一过程涉及到微机接口原理，回去再补补）。

### 产生中断

键盘在中断请求线上发起信号，信号被中断控制器映射成一个**中断向量（一个整形数）**， CPU通过中断描述符（IDT）将中断向量映射对应的函数，这些中断函数被称为中断处理器，由操作系统内核提供。不同的操作系统处理该信息方式不同，我所理解的是，操作系统内核将该键码信息传递给 window server 窗口进程，之后窗口进程又将该键码发松给具体的进程。

> 小结  键盘按压 ===> 高低电平 ===> 通过USB线 ===> USB控制器 ===> 中断请求(CPU) ===> CPU映射具体的中断向量 ===> 映射对应的中断处理器(操作系统) ===>  键码发送至 window serve ===> 键码发送至具体进程

### 解析字符串

浏览器内置一套检查机制，判断该字符串是一个URL，还是一个用户想要查询的内容 keyword。如果不是URL就将该字符串传递给浏览器默认的搜索引擎，搜索引擎根据响应的keyword返回具体的网页

### 发送请求

在此之前，浏览器检查自带的"预加载HSTS（**H**TTP **S**trict **T**ransport **S**ecurity）"列表，网站使用HSTS策略，让浏览器强制使用HTTPS来通信，增加第一次通信的安全性。如果网站不在HSTS列表里面，浏览器向网站发出第一个 HTTP 请求之后，网站会返回浏览器一个响应，请求浏览器只使用 HTTPS 发送请求。

### DNS查询

DNS(Domain Name System) 将**域名**和**IP**互相的映射的一个分布式数据库，DNS使用53/TCP,UDP端口。也就是只为了获得ip地址。域名系统服务器像是一本网站通讯录。当你在浏览器内输入一个网址时，浏览器获取网页之前将会查看域名系统。浏览器需要找到存放你想要的网页的服务器，才能发送 HTTP 请求到正确的地方。就像你要知道商店的地址才能到达那。

- 浏览器检查域名是否在缓存中，chrome://net-internals/#dns目前被chrome被移除了,如果需要看，得通过导出日志的方式查看
- 查看操作系统的DNS缓存

DNS查询有两种方式：**递归**和**迭代**。DNS客户端设置使用的DNS服务器一般都是递归服务器，它负责全权处理客户端的DNS查询请求，直到返回最终结果。而DNS服务器之间一般采用迭代查询方式。

以查询 zh.wikipedia.org 为例：

- 客户端发送查询报文"query zh.wikipedia.org"至DNS服务器，DNS服务器首先检查自身缓存，如果存在记录则直接返回结果。
- 如果记录老化或不存在，则：
  1. DNS服务器向[根域名服务器](https://zh.wikipedia.org/wiki/根網域名稱伺服器)发送查询报文"query zh.wikipedia.org"，根域名服务器返回[顶级域](https://zh.wikipedia.org/wiki/頂級域) .org 的权威域名服务器地址。
  2. DNS服务器向 .org 域的权威域名服务器发送查询报文"query zh.wikipedia.org"，得到[二级域](https://zh.wikipedia.org/wiki/二级域) .wikipedia.org 的权威域名服务器地址。
  3. DNS服务器向 .wikipedia.org 域的权威域名服务器发送查询报文"query zh.wikipedia.org"，得到主机 zh 的A记录，存入自身缓存并返回给客户端。

> 小结：DNS的查询路径：浏览器查看自身的DNS缓存 ===> 调用OS的库函数检查是否在Host文件 /etc/hosts(mac为例子) ===> 发送请求到本地DNS服务器 ===> 上面的步骤。

