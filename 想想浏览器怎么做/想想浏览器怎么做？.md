# 想想浏览器怎么做？

> 我一直在想，有什么办法可以将大学的计算机理论知识统统的串联起来？既然我是一个前端开发工程师，不如从最开始的浏览器输入开始一点点的将过去的知识串联起来。所以通过当我按下回车时，计算机的数据流到底是怎么样的呢？ 因此来写下这篇文章，站在数据的流动理清计算机的每一个点。

###按下"z"键

在此之前，当你输入第一个字符时，chrome会在地址的下方根据你的浏览记录、书签的收藏等内容给出合理的建议，你的每一次输入，chrome后台任务都会以更加精准提示展现给你。甚至在你输入第一个字符是"z"的时候，就会提示[zhihu.com](https://www.zhihu.com)。

### 按下"Enter"键

这里是数据出发的起始点。这个moment，通过键盘接口数字电路(通过二进制表示不同的键位，按下为1,没按为0)，将enter转换为**"13"键盘码值**。键盘控制器将键盘码转换成**ASCII**码通过IO总线专递给处理机（CPU），键盘会向CPU发起中断请求信号。数据通过USB线从键盘传输至计算机，计算机的USB控制器将传递的信号解码。之后将按键的码值传递给操作系统。（这一过程涉及到微机接口原理，回去再补补）。

### 产生中断

键盘在中断请求线上发起信号，信号被中断控制器映射成一个**中断向量（一个整形数）**， CPU通过中断描述符（IDT）将中断向量映射对应的函数，这些中断函数被称为中断处理器，由操作系统内核提供。不同的操作系统处理该信息方式不同，我所理解的是，操作系统内核将该键码信息传递给 window server 窗口进程，之后窗口进程又将该键码发松给具体的进程。

> 小结  键盘按压 ===> 高低电平 ===> 通过USB线 ===> USB控制器 ===> 中断请求(CPU) ===> CPU映射具体的中断向量 ===> 映射对应的中断处理器(操作系统) ===>  键码发送至 window serve ===> 键码发送至具体进程

### 解析字符串

浏览器内置一套检查机制，判断该字符串是一个URL，还是一个用户想要查询的内容 keyword。如果不是URL就将该字符串传递给浏览器默认的搜索引擎，搜索引擎根据响应的keyword返回具体的网页

### 发送请求

在此之前，浏览器检查自带的"预加载HSTS（**H**TTP **S**trict **T**ransport **S**ecurity）"列表，网站使用HSTS策略，让浏览器强制使用HTTPS来通信，增加第一次通信的安全性。如果网站不在HSTS列表里面，浏览器向网站发出第一个 HTTP 请求之后，网站会返回浏览器一个响应，请求浏览器只使用 HTTPS 发送请求。

### DNS查询

DNS(Domain Name System) 将**域名**和**IP**互相的映射的一个分布式数据库，DNS使用53/TCP,UDP端口。**子域名**属于更高一层的域，比如y.qq.com和lol.qq.com是qq.com的两个子域，而qq.com则是**顶级域**.com的子域，在向上就是根域名"."

那么我们如何查询一个域名对应的ip呢，以及域名和ip对应的数量关系又是怎么的？通过**dig命令**就可得知结果。

![Ubuntu18.04-dig命令](/home/lfe/Documents/computeSummary/想想浏览器怎么做/dig.png)

上图可以看到一个qq.com后面还有一个"."的根域名，以及一个域名可以对应多个ip，用来做DNS的负载均衡，同理多个域名也可以对应一个ip，服务器将不同的域名的请求转发到不同的网站程序去处理。

![DNS负载均衡](/home/lfe/Documents/computeSummary/想想浏览器怎么做/dns-app-lb.jpg)

浏览器自己也是自带DNS缓存，现在得通过chrome://net-export/ 导出network日志在这个https://netlog-viewer.appspot.com/#import去查看。

接下来通过介绍DNS的查询方式。

DNS查询有两种方式：**递归**和**迭代**。DNS客户端设置使用的DNS服务器一般都是递归服务器，它负责全权处理客户端的DNS查询请求，直到返回最终结果。而DNS服务器之间一般采用迭代查询方式。上面的dig命令查询就可以看到是哪一个DNS Server。

以查询 lol.qq.com 为例：

- 客户端发送查询报文"query  lol.qq.com"至DNS服务器，DNS服务器首先检查自身缓存，如果存在记录则直接返回结果。
- 如果记录老化或不存在，则：
  1. DNS服务器向根域名服务器发送查询报文"query lol.qq.com"，根域名服务器返回顶级域 .com 的权威域名服务器地址。
  2. DNS服务器向 .com 域的权威域名服务器发送查询报文"query lol.qq.com"，得到二级域 .qq.com 的权威域名服务器地址。
  3. DNS服务器向 .qq.com 域的权威域名服务器发送查询报文"query lol.qq.com"，得到主机 lol 的A记录，存入自身缓存并返回给客户端。

>  小结：DNS的查询路径：浏览器查看自身的DNS缓存 ===> 调用OS的库函数检查是否在Host文件 /etc/hosts(mac为例子) ===> 发送请求到本地DNS服务器 ===> 上面的步骤。

左思右想，如何把传输层、网络层、数据链路层、物理层这几个OSI模型以一种更为合理的角度去理清楚，因此我参照阮大神与其他博主的顺序，站在过去看未来，从计算机网络最原始开始，是如何演化到如今的这么多个层次。各个层次解决什么问题。

每一个层次都会遵循每个层次特定的协议，只有统一的规则，才能够保证互联网的稳定。

### 物理层

计算机网络的物理层也是根据最原始的0\1二进制电信号来通信。就拿光纤通信来说，发送端首先把传输的信息（如话音）变成电信号，然后调制解调器调制到激光器发射的激光束上，使光强随电信号的频率变化而变化，通过光纤发送出去，在接收端收到光信号把它变换成电信号，经解调后回复原信息。物理层不同的传输方式，遵循着不同的协议。比如说：Bluetooth物理层、Varieties of 802.11 Wi-Fi物理层...  但本质上来讲都是变成0\1的电信号，之后组合成复杂的逻辑门数字电路。

> 小结物理层的数据流: 数字比特流 ===> 调制解调器（光猫） ===> 模拟信号（光、电压、红外线） ===> 传播介质 ===> 模拟信号 ===> 数字比特流

![](/home/lfe/Documents/computeSummary/想想浏览器怎么做/modern.jpeg)

### 数据链路层

物理层会遇到什么样的问题？ 在广播式多路访问链路，不同的设备或网络节点在多点的网络上通信，两个站点同时在传输介质上发送数据就会产生冲突，数据链路层可以解决这个问题，以及封装网络层传递的数据包。

#### 以太网协议

局域网（LAN）指的是一个网络为一个单位所拥有，地理位置和站点数据有限，统称。局域网的工作跨越了物理层和数据链路层。以太网是局域网的一种实现方式，但如今以太网占据了绝大多数市场，故某种意义上，以太网就是局域网。

##### 数据帧

以太网规定:一组电信号构成数据链路单元的数据帧。每一个帧的格式由下图组成。

![1octet=8bit](/home/lfe/Documents/computeSummary/想想浏览器怎么做/mac-packet.png)



一个帧以7个字节的前导码和1个字节的帧开始符作为帧的开始。

802.1Q标签是为了构建VLAN，由一些局域网网段构成的与物理位置无关的逻辑组，VLAN的帧增加了4个字节的VLAN标识符，标记此站点属于哪个VLAN，交换机收到广播帧只会转发至同一VLAN，这样可以防止广播风暴。

"数据"则是IP数据包的具体内容，如果数据很长，就必须分割成多个帧进行发送。

CRC是一种根据网络数据包或电脑文件等数据产生简短固定位数校验码的一种**散列函数**， 检查实质内容，将物理层提供的**可能出错的物理连接改造成逻辑上无差错的数据链路**。

数据帧是同步串行传输的，接收器通过一串特定的连续比特或符号来确定一个帧的开始和结束，当一个帧发送出去之后，发送方在下次发送帧之前，需要再发送至少12个octet的空闲线路状态码。假如接收器**在帧传输的过程中**被接入到系统，就会忽视接收到的数据直到检测到一个新的数据帧。

数据链路层在两个网络实体之间提供数据链路连接的创建、维持和释放管理。

![](https://pic1.zhimg.com/80/v2-43a7442e4598a53b28db0f1b3185815c_1440w.jpg)

#### MAC

媒体接入控制（Media Access Control） ，是局域网中数据链路层的下层部分，为局域网提供定址，使得不同设备或网络上的节点可以在多点的网络上通信，而不会互相冲突。

以太网规定，连入网络的所有设备，都必须具有"网卡"接口。数据包必须是从一块网卡，传送到另一块网卡。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。

![img](http://www.ruanyifeng.com/blogimg/asset/201205/bg2012052905.jpg)



每一个网卡都有一个被称为MAC地址的独一无二的48位串行号，它被写在卡上的一块ROM中。在网络上的每一个计算机都拥有一个独一无二的MAC地址。

### 广播机制

如何知道一个局域网中另一台电脑的MAC地址是多少，或者通过一条网线，连接两台主机该如何通信？

通过ARP（Address Resolution Protocol）协议，ARP通过解析网络层地址来找寻数据链路层地址的网络传输协议。如果发送主机和目的主机不在同一个局域网，即使知道了目的主机的MAC地址也无法通信，必须经过路由转发才可以。

```shell
arp -a // 可以查看ARP缓存表
```

以主机A（192.168.0.2）向主机B（192.168.38.3）发送数据为例。

如果在ARP缓存表中没有找到相对应的IP地址，主机A就会在网络上发送一个广播（ARP request），目标MAC地址是“FF.FF.FF.FF.FF.FF”，这表示向同一网段内的所有主机发出这样的询问：“192.168.0.3的MAC地址是什么？”

网络上其他主机并不响应ARP询问，只有主机B接收到这个帧时，才向主机A做出这样的回应（ARP response）：“192.168.0.3的MAC地址是xx-xx-xx-xx-xx-xx”，此回应以单播方式。这样，主机A就知道主机B的MAC地址，它就可以向主机B发送信息。同时它还更新自己的ARP高速缓存（ARP cache），下次再向主机B发送信息时，直接从ARP缓存表里查找就可。

### 交换机

#### 网段

在以太网环境中，一个网段是一个冲突域（碰撞域）。同一网段中的设备共享（包括通过集线器等设备中转连接）同一物理总线，在这一总线上执行CSMA/CD（载波监听多路访问/冲突检测）机制。不同网段间不共享同一物理层，因此不会跨网段发生冲突（碰撞）。

交换机是工作在数据链路层的设备，由它转接的两组设备不在同一网段中。交换机通过报文交换接收和转发数据到目标设备，在数据链路层使用MAC地址转发数据。多个计算机通过网线连接至一个交换机，它们之间就可以互相通信。

如果引入路由功能，这些交换机也可以在网络层转发数据。

#### 工作方式

交换机配置好了，工作过程：

- 收到某网段（设为A）MAC地址为X的计算机发给MAC地址为Y的计算机的数据包。交换机从而记下了MAC地址X在网段A。这称为学习（learning）。
- 交换机还不知道MAC地址Y在哪个网段上，于是向除了A以外的所有网段转发该数据包。这称为泛洪（flooding）。
- MAC地址Y的计算机收到该数据包，向MAC地址X发出确认包。交换机收到该包后，从而记录下MAC地址Y所在的网段。
- 交换机向MAC地址X转发确认包。这称为转发（forwarding）。
- 交换机收到一个数据包，查表后发现该数据包的来源地址与目的地址属于同一网段。交换机将不处理该数据包。这称为过滤（filtering）。
- A ===> 交换机先记录A，查看地址表，广播除了A发送给全部网段 ===> Y收到，发送确认包给X ===> 交换机记录Y，并转发确认包 ===> 如果属于同一网段则不处理。

交换机有 记录、广播 、转发、过滤的行为

### PPP协议